# Emergency Hotfix Procedure

## 🚨 When to Use This Procedure

Use this procedure ONLY for critical production issues that require immediate action:

- Security vulnerabilities actively being exploited
- Complete service outage affecting all users
- Data corruption or loss in progress
- Critical functionality completely broken (login, document access, data saving)

## ⚡ Quick Hotfix (< 5 minutes)

### Step 1: Immediate Mitigation

**Feature Flags (Fastest - 30 seconds)**
```bash
# Disable problematic feature immediately
curl -X POST https://obsidiancomments.serverado.app/api/feature-flags/PROBLEMATIC_FEATURE \
  -H "Content-Type: application/json" \
  -H "x-admin-token: $ADMIN_TOKEN" \
  -d '{"enabled": false}'
```

**Rollback (2-3 minutes)**
```bash
# If feature flags don't resolve it, rollback
./scripts/rollback.sh production
```

### Step 2: Verify Fix
```bash
# Run smoke tests
./scripts/smoke.sh https://obsidiancomments.serverado.app

# Check health
curl https://obsidiancomments.serverado.app/api/health
```

## 🔧 Emergency Code Deploy (< 15 minutes)

### Step 1: Create Emergency Branch
```bash
# Create hotfix branch from main
git checkout main
git pull origin main
git checkout -b hotfix/emergency-$(date +%Y%m%d-%H%M)

# Make MINIMAL fix - no refactoring, no extra features
# Edit only the files that fix the immediate issue

# Commit with clear message
git add .
git commit -m "HOTFIX: Brief description of critical fix

Fixes: Critical issue description
Risk: Low/Medium/High
Rollback: Available via ./scripts/rollback.sh

🤖 Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"
```

### Step 2: Emergency CI/CD Bypass
```bash
# Build and tag as hotfix
docker build -t obsidiancomments-backend:hotfix-$(date +%Y%m%d-%H%M) -f packages/backend/Dockerfile.production packages/backend/
docker build -t obsidiancomments-frontend:hotfix-$(date +%Y%m%d-%H%M) -f packages/frontend/Dockerfile.production packages/frontend/

# Tag and push to registry
docker tag obsidiancomments-backend:hotfix-$(date +%Y%m%d-%H%M) ghcr.io/pangeafate/obsidiancomments-backend:emergency
docker tag obsidiancomments-frontend:hotfix-$(date +%Y%m%d-%H%M) ghcr.io/pangeafate/obsidiancomments-frontend:emergency

docker push ghcr.io/pangeafate/obsidiancomments-backend:emergency
docker push ghcr.io/pangeafate/obsidiancomments-frontend:emergency
```

### Step 3: Deploy Hotfix
```bash
# Deploy with emergency tag
./scripts/deploy.sh production emergency
```

### Step 4: Verify and Document
```bash
# Smoke test
./scripts/smoke.sh https://obsidiancomments.serverado.app

# Create incident report (automatic)
# This will be generated by rollback.sh or you can create manually
```

## 📋 Post-Emergency Checklist

### Immediate (< 30 minutes)
- [ ] Verify fix resolves the issue completely
- [ ] All smoke tests pass
- [ ] Performance is normal (check monitoring)
- [ ] No new errors in logs
- [ ] Customer-facing communications sent (if applicable)

### Within 2 Hours
- [ ] Create proper PR for the hotfix
- [ ] Merge hotfix back to main branch
- [ ] Update documentation if needed
- [ ] Schedule post-mortem meeting
- [ ] Update monitoring/alerting if gaps identified

### Within 24 Hours
- [ ] Conduct post-mortem
- [ ] Document root cause
- [ ] Implement preventive measures
- [ ] Update runbooks
- [ ] Review monitoring coverage

## 🔐 Access Requirements

### Required Credentials
- Production server SSH access (`$DEPLOY_KEY`)
- Docker registry access (`GITHUB_TOKEN`)
- Admin API token (`$ADMIN_TOKEN`)
- Database access (if needed)

### Required Permissions
- GitHub repository push access
- Docker registry push access
- Production server deployment access
- Admin API access

## 📱 Emergency Contacts

### Technical Team
- **On-call Engineer**: [Contact info]
- **Database Expert**: [Contact info]
- **Security Lead**: [Contact info]

### Business Team
- **Product Manager**: [Contact info]
- **Customer Success**: [Contact info]
- **Executive Team**: [Contact info]

## 🚫 What NOT to Do

- ❌ Don't make multiple changes at once
- ❌ Don't skip smoke tests
- ❌ Don't deploy without backing up current version
- ❌ Don't panic - follow the procedure
- ❌ Don't bypass all CI/CD unless absolutely necessary
- ❌ Don't forget to document the incident
- ❌ Don't make large architectural changes
- ❌ Don't deploy untested code

## 🛠️ Common Emergency Scenarios

### Database Connection Issues
```bash
# Check database health
curl https://obsidiancomments.serverado.app/api/health/detailed

# Restart database service
ssh deploy@obsidiancomments.serverado.app "docker-compose restart postgres"
```

### Memory/CPU Issues
```bash
# Check resource usage
ssh deploy@obsidiancomments.serverado.app "docker stats --no-stream"

# Restart high-usage containers
ssh deploy@obsidiancomments.serverado.app "docker-compose restart backend frontend"
```

### SSL Certificate Issues
```bash
# Renew SSL certificates
ssh deploy@obsidiancomments.serverado.app "cd ~/obsidian-comments && ./scripts/setup-ssl-certificates.sh"
```

### WebSocket/HocusPocus Issues
```bash
# Disable collaborative editing via feature flag
curl -X POST https://obsidiancomments.serverado.app/api/feature-flags/COLLABORATIVE_EDITING \
  -H "Content-Type: application/json" \
  -H "x-admin-token: $ADMIN_TOKEN" \
  -d '{"enabled": false}'

# Or restart HocusPocus
ssh deploy@obsidiancomments.serverado.app "docker-compose restart hocuspocus"
```

## 📊 Monitoring During Emergency

### Key Metrics to Watch
- API response times
- Error rates
- Memory and CPU usage
- Database connection count
- WebSocket connection count

### Log Locations
```bash
# Application logs
ssh deploy@obsidiancomments.serverado.app "docker-compose logs -f --tail=100 backend"

# Nginx logs
ssh deploy@obsidiancomments.serverado.app "docker-compose logs -f --tail=100 nginx"

# Database logs
ssh deploy@obsidiancomments.serverado.app "docker-compose logs -f --tail=100 postgres"
```

## 🔄 Recovery Verification

### Smoke Test Checklist
- [ ] Homepage loads
- [ ] API health check returns 200
- [ ] Can create new document
- [ ] Can view existing document
- [ ] Can edit document (if applicable)
- [ ] CORS headers present
- [ ] No JavaScript errors in console

### Performance Verification
- [ ] API response time < 500ms
- [ ] Page load time < 3 seconds
- [ ] No memory leaks
- [ ] Database queries completing normally

Remember: **Speed is important, but correctness is critical. Don't make the problem worse.**