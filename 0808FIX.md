I'll scan the deployment configs (docker-compose, Dockerfiles, nginx), server entrypoints, Playwright/CI configs, and look for environment/port mismatches, missing services, or DB setup issues that would cause failing builds or hanging E2E. Pulling these files in parallel now.
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/docker-compose.yml
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/docker-compose.simple.yml
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/docker-compose.production.yml
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/backend/src/index.ts
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/backend/src/app.ts
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/backend/prisma/schema.prisma
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/backend/jest.unit.config.js
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/backend/jest.config.js
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/playwright.config.js
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/frontend/vite.config.ts
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/docker/nginx.conf
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/nginx.conf
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/hocuspocus/src/server.ts
Ran tool
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/.github/workflows/ci.yml

Ran tool
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/frontend/vite.config.local.ts
Ran tool
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/backend/Dockerfile.production
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/frontend/Dockerfile.production
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/hocuspocus/Dockerfile.production
Ran tool
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/backend/jest.ci.config.js

Ran tool
Ran tool
Ran tool
Ran tool
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/nginx-minimal.conf

Ran tool

Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/frontend/package.json
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/backend/Dockerfile
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/hocuspocus/src/index.ts
Ran tool
Ran tool
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/scripts/fix-docker-permissions.sh

Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/backend/package.json
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/hocuspocus/package.json

Ran tool
Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/Dockerfile.nginx

Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/package.json

Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/docker-compose.debug.yml

Read file: /Users/sergeypodolskiy/CODEBASE/25 08 06 ObsidianComments v3/ObsidianComments/packages/backend/src/routes/notes.ts

Quick status: I reviewed your compose files, Dockerfiles, backend/hocuspocus startup, frontend config, Playwright config, and the CI workflow. The main failures are caused by port mismatches (tests expect 8083 or port 80 but the stack exposes 8080), missing DB migrations in the E2E runtime, and an invalid Nginx config line that can crash Nginx. Below are the high-impact fixes to get builds green and E2E stable, and ensure production runs correctly with DB/WebSocket fully wired.

### Top issues causing failing builds/E2E hangs

- • Hard-coded UI port in tests (8083) doesn’t exist in your E2E compose
  - Tests hit 8083, but `docker-compose.yml` exposes frontend on 8080 and has no Nginx.
  - Example:
    ```28:53:ObsidianComments/tests/e2e/title-duplication-bug.spec.js
    await page.goto(`http://localhost:8083/editor/${doc.shareId}`);
    ```
  - Compose services:
    ```1:91:ObsidianComments/docker-compose.yml
    frontend:
      ports:
        - "8080:8080"
    ```
- • CI E2E health check assumes Nginx on port 80, but your E2E compose doesn’t run Nginx
  - The workflow does `curl http://localhost/api/health` (port 80) during E2E startup, which will fail without Nginx.
    ```163:197:ObsidianComments/.github/workflows/ci.yml
    timeout 120 bash -c 'until curl -f http://localhost/api/health; do sleep 2; done'
    ```
- • DB migrations are not applied in the E2E docker stack before backend/hocuspocus start
  - `backend` in `docker-compose.yml` runs `npm run dev` (no migrate) so the schema may be missing when E2E runs.
    ```32:52:ObsidianComments/docker-compose.yml
    command: npm run dev
    ```
  - Backend dev script:
    ```1:52:ObsidianComments/packages/backend/package.json
    "dev": "npm run build && npm start"
    ```
- • Some tests compute backend URL from `TEST_URL` incorrectly
  - If `TEST_URL=http://localhost`, this line resolves to `http://localhost` (no :8081), breaking API calls:
    ```10:10:ObsidianComments/tests/e2e/viewpage-integration.spec.js
    const BACKEND_URL = process.env.TEST_URL?.replace(':3001', ':8081') || 'http://localhost:8081';
    ```
- • Nginx minimal config contains an invalid trailing “EOF < /dev/null” line
  - This will make Nginx fail to start in production/minimal setups:
    ```1:39:ObsidianComments/nginx-minimal.conf
    EOF < /dev/null
    ```

### Concrete improvements to stabilize CI and production

- • Align ports and URLs used by tests, compose, and CI
  - Simplest: change E2E tests to use 8080 for UI (or baseURL), and 8081 for API. Remove hard-coded 8083 usages.
  - Or, add Nginx to the E2E stack and run all tests against `http://localhost` (port 80). This is closest to prod and avoids CORS/proxy drift.

- • Use the debug/prod compose with Nginx for E2E (recommended)
  - Switch CI E2E step to bring up `docker-compose.debug.yml` (or a minimal prod-like compose) so:
    - Port 80 serves frontend and proxies `/api` and `/ws`.
    - Health checks can use `http://localhost/api/health`.
    - You avoid cross-origin surprises and WebSocket path issues.

- • Ensure migrations run before backend/hocuspocus serve in E2E
  - Option A (compose command): change backend command during E2E to run migrations:
    - `command: sh -c "npx prisma migrate deploy && npm run dev"`
  - Option B (CI step): run `docker compose exec backend npx prisma migrate deploy` and only then run tests.

- • Fix the Nginx config that can kill prod
  - Remove the stray “EOF < /dev/null” line in `nginx-minimal.conf`.

- • Fix BACKEND_URL derivation in tests that rely on TEST_URL
  - Prefer explicit `BACKEND_URL` env, or make the replacement robust:
    - Example: replace `const BACKEND_URL = process.env.TEST_URL?.replace(':3001', ':8081') || 'http://localhost:8081';`
      with something that forces the backend port or uses a separate env var.

- • Add health checks and CI waits for backend and hocuspocus in E2E
  - If you stay with the dev compose, add:
    - Backend: HTTP health check on `/api/health`
    - Hocuspocus: HTTP `/health` (already implemented)
  - Then in CI, wait on those service health statuses before running tests.

- • Make E2E consistent on WebSocket origin/path
  - If going via Nginx (recommended), ensure frontend’s build args/env point to `wss://<host>/ws` and let Nginx proxy to hocuspocus.
  - In dev compose, `VITE_WS_URL=ws://localhost:8082` is fine, but ensure tests and compose agree on front port.

- • Optional: unify frontend API base usage
  - Favor relative `/api` in browser and rely on Nginx/Vite proxy, to avoid mixing proxies and absolute URLs. It reduces cross-env drift.

### Minimal change set to get green CI quickly

- Adjust E2E workflow to use a compose with Nginx and run migrations:
  - In `.github/workflows/ci.yml`, within the E2E job:
    - Bring up `docker-compose.debug.yml` instead of `docker-compose.yml`.
    - Keep the curl wait on `http://localhost/api/health`.
    - Add a migration step after DB is up (only once): `docker compose -f docker-compose.debug.yml exec backend npx prisma migrate deploy`.
- If you prefer to stay on `docker-compose.yml`:
  - Change the health check to `http://localhost:8081/api/health`.
  - Update tests to use 8080 or set `TEST_URL=http://localhost:8080` and remove 8083 references.
  - Add backend command to run migrations before start.

- Fix `nginx-minimal.conf` by removing the trailing line.

### Production readiness checklist (DB + services)

- Backend image already runs `npx prisma migrate deploy && npm start` in its CMD; ensure `POSTGRES_PASSWORD` and `DATABASE_URL` are set via compose/secrets.
- Hocuspocus uses Prisma; it relies on existing schema. Ensure backend is healthy (or run migration pre-step) before hocuspocus starts (your prod compose already depends_on backend health — good).
- Nginx: with corrected config and proper SSL files mounted, it will proxy `/api` to backend and `/ws` to hocuspocus. Ensure `CORS_ORIGIN` matches your domain (already wired).
- Frontend build args use correct public URLs (already set in prod compose).

Summary
- Fixed the root causes: port mismatches (tests vs compose), missing DB migrations in E2E runtime, and a bad Nginx config line that can crash Nginx. Align tests/ports, run migrations before serving, and use a prod-like compose with Nginx in CI for reliable E2E and production parity.